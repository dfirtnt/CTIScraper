{% extends "base.html" %}

{% block title %}Sources - CTI Scraper{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Threat Intelligence Sources</h1>
                <p class="mt-2 text-gray-600">Manage and monitor your threat intelligence collection sources</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500">Total Sources</p>
                <p class="text-2xl font-bold text-blue-600">{{ sources|length }}</p>
            </div>
        </div>
    </div>


    <!-- Quality Summary -->
    <!-- Debug: quality_stats count: {{ quality_stats|length }} -->
    {% if quality_stats %}
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">üìä Overall Quality Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center">
                <a href="/articles" class="text-2xl font-bold text-gray-900 hover:text-blue-600 hover:underline cursor-pointer">
                    {{ quality_stats.values()|sum(attribute='total_articles') }}
                </a>
                <p class="text-sm text-gray-500">Total Articles</p>
            </div>
            <div class="text-center">
                <a href="/articles?classification=rejected" class="text-2xl font-bold text-red-600 hover:text-red-800 hover:underline cursor-pointer">
                    {{ quality_stats.values()|sum(attribute='rejected_count') }}
                </a>
                <p class="text-sm text-gray-500">Total Rejected</p>
            </div>
            <div class="text-center">
                <a href="/articles?classification=chosen" class="text-2xl font-bold text-green-600 hover:text-green-800 hover:underline cursor-pointer">
                    {{ quality_stats.values()|sum(attribute='chosen_count') }}
                </a>
                <p class="text-sm text-gray-500">Total Chosen</p>
            </div>
            <div class="text-center">
                {% set total_articles = quality_stats.values()|sum(attribute='total_articles') %}
                {% set total_rejected = quality_stats.values()|sum(attribute='rejected_count') %}
                {% if total_articles > 0 %}
                    <a href="/articles?classification=rejected" class="text-2xl font-bold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer">
                        {{ (total_rejected / total_articles * 100)|round(1) }}%
                    </a>
                {% else %}
                    <span class="text-2xl font-bold text-blue-600">0%</span>
                {% endif %}
                <p class="text-sm text-gray-500">Overall Rejection Rate</p>
            </div>
        </div>
        
        <!-- Sources Requiring Attention -->
        <div class="border-t pt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">üìä Rejection Rate Analysis</h4>
            {% set high_rejection = [] %}
            {% set moderate_rejection = [] %}
            {% set low_rejection = [] %}
            
            {% for source in sources %}
                {% if source.id in quality_stats %}
                    {% set stat = quality_stats[source.id] %}
                    {% set rate = stat.rejection_rate|float %}
                    {% if rate > 70 %}
                        {% set high_rejection = high_rejection + [source.name + ' (' + stat.rejection_rate|string + '%)'] %}
                    {% elif rate > 50 %}
                        {% set moderate_rejection = moderate_rejection + [source.name + ' (' + stat.rejection_rate|string + '%)'] %}
                    {% else %}
                        {% set low_rejection = low_rejection + [source.name + ' (' + stat.rejection_rate|string + '%)'] %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% if high_rejection|length > 0 %}
            <div class="mb-2">
                <p class="text-xs text-red-600 font-medium">High Rejection Rate (>70%):</p>
                <p class="text-xs text-gray-600">{{ high_rejection|join(', ') }}</p>
            </div>
            {% endif %}
            {% if moderate_rejection|length > 0 %}
            <div class="mb-2">
                <p class="text-xs text-yellow-600 font-medium">Moderate Rejection Rate (50-70%):</p>
                <p class="text-xs text-gray-600">{{ moderate_rejection|join(', ') }}</p>
            </div>
            {% endif %}
            {% if low_rejection|length > 0 %}
            <div>
                <p class="text-xs text-green-600 font-medium">Low Rejection Rate (<50%):</p>
                <p class="text-xs text-gray-600">{{ low_rejection|join(', ') }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <p class="text-sm text-yellow-700">‚ö†Ô∏è No quality statistics available</p>
    </div>
    {% endif %}

    <!-- Database Status Banner -->
    <div id="dbStatusBanner" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <span class="text-yellow-400 text-lg">‚ö†Ô∏è</span>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Database Status</h3>
                <p class="text-sm text-yellow-700">
                    The database is experiencing temporary locking issues. 
                    Source status changes may not persist until you refresh the page.
                </p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="window.location.reload()" 
                        class="bg-yellow-100 text-yellow-800 rounded-md px-3 py-1 text-sm font-medium hover:bg-yellow-200">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Sources List -->
    <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Configured Sources</h3>
                    <p class="text-sm text-gray-500">All threat intelligence sources and their current status</p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="mr-1">üìä</span>
                        Sorted by Acceptance Rate
                    </div>
                </div>
            </div>
        </div>

        {% if sources %}
        <div class="divide-y divide-gray-200">
            {% for source in sources %}
            <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <h4 class="text-lg font-medium text-gray-900">
                                <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer">
                                    {{ source.name }}
                                </a>
                            </h4>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                         {% if source.active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if source.active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <p class="text-sm text-gray-500">URL</p>
                                <p class="text-sm font-medium text-gray-900 break-all">{{ source.url }}</p>
                            </div>
                            {% if source.rss_url %}
                            <div>
                                <p class="text-sm text-gray-500">RSS Feed</p>
                                <p class="text-sm font-medium text-gray-900 break-all">{{ source.rss_url }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3">
                            <div>
                                <p class="text-sm text-gray-500">Collection Method</p>
                                <p class="text-sm font-medium text-gray-900">
                                    {% if source.rss_url %}RSS Feed{% else %}Web Scraping{% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Collection Period</p>
                                <p class="text-sm font-medium text-gray-900">
                                    {% if source.config and source.config.collection_days %}{{ source.config.collection_days }} days{% else %}90 days (default){% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Last Check</p>
                                <p class="text-sm font-medium text-gray-900">
                                    {% if source.last_check %}{{ source.last_check.strftime('%Y-%m-%d %H:%M') }}{% else %}Never{% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Articles Collected</p>
                                <p class="text-sm font-medium text-gray-900">{{ source.total_articles or 0 }}</p>
                            </div>
                        </div>

                        <!-- Quality Metrics -->
                        {% if source.id in quality_stats and quality_stats[source.id].total_articles > 0 %}
                        {% set stat = quality_stats[source.id] %}
                        <div class="bg-gray-50 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-medium text-gray-700">üìä Quality Metrics</h5>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                                 {% if stat.acceptance_rate >= 80 %}bg-green-100 text-green-800
                                                 {% elif stat.acceptance_rate >= 60 %}bg-yellow-100 text-yellow-800
                                                 {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ stat.acceptance_rate }}% Acceptance Rate
                                    </span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <p class="text-xs text-gray-500">Total Articles</p>
                                    <a href="/articles?source={{ source.id }}" 
                                       class="text-sm font-medium text-gray-900 hover:text-blue-600 hover:underline cursor-pointer">
                                        {{ stat.total_articles }}
                                    </a>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Rejected</p>
                                    <a href="/articles?source={{ source.id }}&classification=rejected" 
                                       class="text-sm font-medium text-red-600 hover:text-red-800 hover:underline cursor-pointer">
                                        {{ stat.rejected_count }} ({{ stat.rejection_rate }}%)
                                    </a>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Chosen</p>
                                    <a href="/articles?source={{ source.id }}&classification=chosen" 
                                       class="text-sm font-medium text-green-600 hover:text-green-800 hover:underline cursor-pointer">
                                        {{ stat.chosen_count }} ({{ stat.acceptance_rate }}%)
                                    </a>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Unclassified</p>
                                    <a href="/articles?source={{ source.id }}&classification=unclassified" 
                                       class="text-sm font-medium text-gray-600 hover:text-gray-800 hover:underline cursor-pointer">
                                        {{ stat.unclassified_count }}
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if source.description %}
                        <div class="mb-3">
                            <p class="text-sm text-gray-500">Description</p>
                            <p class="text-sm text-gray-900">{{ source.description }}</p>
                        </div>
                        {% endif %}

                        <div class="flex items-center space-x-2">
                            <button onclick="showActivationModal({{ source.id }}, '{{ source.name }}', {{ source.active|lower }})" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                <span class="mr-2">‚öôÔ∏è</span>
                                {% if source.active %}Deactivate{% else %}Activate{% endif %}
                            </button>

                            <button onclick="showSourceStats({{ source.id }})" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                <span class="mr-2">üìä</span>
                                Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="px-6 py-12 text-center">
            <div class="text-gray-400 text-6xl mb-4">üîó</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No sources configured</h3>
            <p class="text-gray-500">Configure threat intelligence sources to start collecting data.</p>
        </div>
        {% endif %}
    </div>

    <!-- Source Statistics -->
    {% if sources %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Active Sources -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                        <span class="text-white text-lg">‚úÖ</span>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Active Sources</p>
                    <p class="text-2xl font-bold text-gray-900">{{ sources|selectattr('active')|list|length }}</p>
                </div>
            </div>
        </div>

        <!-- RSS Sources -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                        <span class="text-white text-lg">üì°</span>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">RSS Sources</p>
                    <p class="text-2xl font-bold text-gray-900">{{ sources|selectattr('rss_url')|list|length }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/" class="flex items-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <span class="mr-3">üè†</span>
                Dashboard
            </a>
            <a href="/articles" class="flex items-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <span class="mr-3">üì∞</span>
                View Articles
            </a>
            <button onclick="window.location.reload()" class="flex items-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                <span class="mr-3">üîÑ</span>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Activation Modal -->
<div id="activationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="activationModalTitle">
                            Source Activation
                        </h3>
                        <div class="mt-4">
                            <div id="activationModalContent" class="text-sm text-gray-500">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="confirmActivation()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Confirm
                </button>
                <button type="button" onclick="closeActivationModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying results -->
<div id="resultModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">
                            Source Action Result
                        </h3>
                        <div class="mt-2">
                            <div id="modalContent" class="text-sm text-gray-500">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for activation modal
let currentSourceId = null;
let currentSourceName = null;
let currentSourceActive = null;

function showActivationModal(sourceId, sourceName, isActive) {
    currentSourceId = sourceId;
    currentSourceName = sourceName;
    currentSourceActive = isActive;
    
    const action = isActive ? 'Deactivate' : 'Activate';
    document.getElementById('activationModalTitle').textContent = `${action} Source`;
    
    let content = `<div class="space-y-4">`;
    content += `<p><strong>Source:</strong> ${sourceName}</p>`;
    content += `<p><strong>Action:</strong> ${action}</p>`;
    
    if (!isActive) {
        content += `<div class="mt-4">`;
        content += `<label for="collectionDays" class="block text-sm font-medium text-gray-700 mb-2">Historical Collection Period</label>`;
        content += `<div class="flex items-center space-x-2">`;
        content += `<input type="number" id="collectionDays" min="1" max="365" value="90" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">`;
        content += `<span class="text-sm text-gray-500">days</span>`;
        content += `</div>`;
        content += `<p class="text-xs text-gray-500 mt-1">How far back to collect articles from this source (1-365 days)</p>`;
        content += `</div>`;
    }
    
    content += `</div>`;
    
    document.getElementById('activationModalContent').innerHTML = content;
    document.getElementById('activationModal').classList.remove('hidden');
}

function closeActivationModal() {
    document.getElementById('activationModal').classList.add('hidden');
    currentSourceId = null;
    currentSourceName = null;
    currentSourceActive = null;
}

async function confirmActivation() {
    if (!currentSourceId) return;
    
    try {
        showLoadingModal('Updating Source', 'Processing source activation...');
        
        const collectionDays = currentSourceActive ? null : document.getElementById('collectionDays').value;
        
        const response = await fetch(`/api/sources/${currentSourceId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                collection_days: collectionDays ? parseInt(collectionDays) : null
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            let content = `<div class="space-y-3">`;
            content += `<p><strong>Source:</strong> ${result.source_name}</p>`;
            content += `<p><strong>Previous Status:</strong> ${result.old_status ? 'Active' : 'Inactive'}</p>`;
            content += `<p><strong>New Status:</strong> <span class="${result.new_status ? 'text-green-600' : 'text-red-600'}">${result.new_status ? 'Active' : 'Inactive'}</span></p>`;
            
            if (collectionDays && result.collection_days) {
                content += `<p><strong>Collection Period:</strong> ${result.collection_days} days</p>`;
            }
            
            content += `<p class="text-sm text-gray-500">${result.message}</p>`;
            
            if (result.success) {
                content += `<div class="mt-3 p-3 bg-green-50 border border-green-200 rounded">`;
                content += `<p class="text-sm text-green-800">‚úÖ Status updated successfully!</p>`;
                content += `</div>`;
            }
            
            if (result.note) {
                content += `<div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">`;
                content += `<p class="text-sm text-yellow-800"><strong>Note:</strong> ${result.note}</p>`;
                content += `</div>`;
            }
            content += `</div>`;
            
            showModal('Source Status Updated', content);
            closeActivationModal();
            
            // Auto-refresh the page if database was updated
            if (result.database_updated) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                // If database update failed, show a manual refresh button and status banner
                setTimeout(() => {
                    const modalContent = document.getElementById('modalContent');
                    if (modalContent) {
                        modalContent.innerHTML += `
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-sm text-blue-800">
                                    <strong>Manual Refresh Required:</strong> 
                                    Click the refresh button below to see current status.
                                </p>
                                <button onclick="window.location.reload()" 
                                        class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    üîÑ Refresh Page
                                </button>
                            </div>
                        `;
                    }
                    
                    // Show the database status banner
                    const banner = document.getElementById('dbStatusBanner');
                    if (banner) {
                        banner.classList.remove('hidden');
                    }
                }, 1000);
            }
        } else {
            showModal('Update Failed', `<p class="text-red-600">Failed to update source: ${result.detail || 'Unknown error'}</p>`);
        }
    } catch (error) {
        showModal('Update Error', `<p class="text-red-600">Error updating source: ${error.message}</p>`);
    }
}

// Close activation modal when clicking outside
document.getElementById('activationModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeActivationModal();
    }
});

async function showSourceStats(sourceId) {
    try {
        showLoadingModal('Loading Stats', 'Fetching source statistics...');
        
        const response = await fetch(`/api/sources/${sourceId}/stats`);
        const stats = await response.json();
        
        if (response.ok) {
            let content = `<div class="space-y-3">`;
            content += `<p><strong>Source:</strong> ${stats.source_name}</p>`;
            content += `<p><strong>Status:</strong> <span class="${stats.active ? 'text-green-600' : 'text-red-600'}">${stats.active ? 'Active' : 'Inactive'}</span></p>`;
            content += `<p><strong>Collection Method:</strong> ${stats.collection_method}</p>`;
            content += `<p><strong>Total Articles:</strong> ${stats.total_articles}</p>`;
            content += `<p><strong>Average Hunt Score:</strong> <span class="${stats.avg_hunt_score >= 60 ? 'text-green-600' : stats.avg_hunt_score >= 40 ? 'text-yellow-600' : 'text-red-600'}">${stats.avg_hunt_score}/100</span></p>`;
            content += `<p><strong>Average Content Length:</strong> ${stats.avg_content_length} characters</p>`;
            content += `<p><strong>Average Quality Score:</strong> ${stats.avg_quality_score}/75</p>`;
            content += `<p><strong>Last Check:</strong> ${stats.last_check ? new Date(stats.last_check).toLocaleString() : 'Never'}</p>`;
            
            if (Object.keys(stats.articles_by_date).length > 0) {
                content += `<div class="mt-4"><strong>Recent Activity:</strong></div>`;
                content += `<div class="max-h-32 overflow-y-auto">`;
                const sortedDates = Object.keys(stats.articles_by_date).sort().reverse().slice(0, 10);
                for (const date of sortedDates) {
                    content += `<p class="text-xs">${date}: ${stats.articles_by_date[date]} articles</p>`;
                }
                content += `</div>`;
            }
            content += `</div>`;
            
            showModal('Source Statistics', content);
        } else {
            showModal('Stats Error', `<p class="text-red-600">Failed to load stats: ${stats.detail || 'Unknown error'}</p>`);
        }
    } catch (error) {
        showModal('Stats Error', `<p class="text-red-600">Error loading stats: ${error.message}</p>`);
    }
}


function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalContent').innerHTML = content;
    document.getElementById('resultModal').classList.remove('hidden');
}

function showLoadingModal(title, message) {
    showModal(title, `<div class="flex items-center space-x-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div><span>${message}</span></div>`);
}

function closeModal() {
    document.getElementById('resultModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('resultModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
