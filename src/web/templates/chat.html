{% extends "base.html" %}

{% block title %}Threat Intelligence Chat - CTI Scraper{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Threat Intelligence Chat</h1>
                    <p class="mt-2 text-gray-600">Ask questions about recent cyber threats, malware, and attack techniques</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-4">
                        <button 
                            onclick="trainOnBlogContent()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                        >
                            ðŸ§  Train on Blog Content
                        </button>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-500">Mistral AI Online</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-lg shadow-sm flex flex-col h-96">
            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Welcome Message -->
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm">ðŸ¤–</span>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>Threat Intelligence Assistant:</strong> Hello! I'm your AI assistant powered by Mistral AI, trained on cybersecurity blog content and threat intelligence reports. 
                                I can help you with questions about recent cyber threats, malware, attack techniques, machine learning evaluation, and more. 
                                I have access to a comprehensive threat intelligence database with articles from CrowdStrike, Unit 42, 
                                and other leading security researchers and bloggers.
                            </p>
                            <div class="mt-3">
                                <p class="text-xs text-blue-600 font-medium">Try asking me about:</p>
                                <ul class="text-xs text-blue-600 mt-1 space-y-1">
                                    <li>â€¢ Recent ransomware attacks and trends</li>
                                    <li>â€¢ New malware families and techniques</li>
                                    <li>â€¢ APT group activities and TTPs</li>
                                    <li>â€¢ Threat hunting methodologies</li>
                                    <li>â€¢ Incident response best practices</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <form id="chatForm" class="flex space-x-3">
                    <div class="flex-1">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask about recent threats, malware, or attack techniques..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            autocomplete="off"
                        >
                    </div>
                    <button 
                        type="submit" 
                        id="sendButton"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                    >
                        Send
                    </button>
                </form>
                
                <!-- Quick Actions -->
                <div class="mt-3 flex flex-wrap gap-2">
                    <button 
                        onclick="askQuestion('What are the latest ransomware trends?')"
                        class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                    >
                        Latest Ransomware Trends
                    </button>
                    <button 
                        onclick="askQuestion('Tell me about recent APT activities')"
                        class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                    >
                        Recent APT Activities
                    </button>
                    <button 
                        onclick="askQuestion('What are the newest malware families?')"
                        class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                    >
                        New Malware Families
                    </button>
                    <button 
                        onclick="askQuestion('How to hunt for persistence techniques?')"
                        class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                    >
                        Persistence Hunting
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Controls -->
        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-500">
                <span id="messageCount">0</span> messages in conversation
            </div>
            <div class="flex space-x-2">
                <button 
                    onclick="clearChat()"
                    class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                >
                    Clear Chat
                </button>
                <button 
                    onclick="exportChat()"
                    class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                >
                    Export Chat
                </button>
            </div>
        </div>

        <!-- Information Panel -->
        <div class="mt-6 bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">About This Chatbot</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">Capabilities</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ Query threat intelligence database</li>
                        <li>â€¢ Provide context from real reports</li>
                        <li>â€¢ Explain technical concepts</li>
                        <li>â€¢ Help with threat hunting</li>
                        <li>â€¢ Cite sources for information</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">Data Sources</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ CrowdStrike Intelligence Blog</li>
                        <li>â€¢ Unit 42 (Palo Alto Networks)</li>
                        <li>â€¢ The DFIR Report</li>
                        <li>â€¢ Microsoft Security Response Center</li>
                        <li>â€¢ Other leading security researchers</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let messageCount = 0;

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = input.value.trim();
        if (message) {
            sendMessage(message);
            input.value = '';
        }
    });
    
    // Auto-focus input
    input.focus();
});

async function sendMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // Add user message
    addMessage('user', message);
    
    // Show typing indicator
    const typingIndicator = addTypingIndicator();
    
    try {
        // Send to API
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        typingIndicator.remove();
        
        // Add assistant response
        addMessage('assistant', data.response, data.sources);
        
    } catch (error) {
        console.error('Error:', error);
        typingIndicator.remove();
        addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
    }
}

function addMessage(role, content, sources = []) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-3';
    
    const isUser = role === 'user';
    const icon = isUser ? 'ðŸ‘¤' : 'ðŸ¤–';
    const bgColor = isUser ? 'bg-blue-500' : 'bg-gray-500';
    const messageBg = isUser ? 'bg-blue-600 text-white' : 'bg-gray-50 text-gray-800';
    
    messageDiv.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center">
                <span class="text-white text-sm">${icon}</span>
            </div>
        </div>
        <div class="flex-1">
            <div class="${messageBg} rounded-lg p-4">
                <p class="text-sm whitespace-pre-wrap">${content}</p>
                ${sources.length > 0 ? `
                    <div class="mt-3 pt-3 border-t ${isUser ? 'border-blue-400' : 'border-gray-200'}">
                        <p class="text-xs ${isUser ? 'text-blue-200' : 'text-gray-600'} font-medium">Sources:</p>
                        <div class="mt-1 space-y-1">
                            ${sources.map(url => `<a href="${url}" target="_blank" class="text-xs ${isUser ? 'text-blue-200 hover:text-blue-100' : 'text-blue-600 hover:text-blue-500'} underline block truncate">${url}</a>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
            <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</p>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    messageCount++;
    document.getElementById('messageCount').textContent = messageCount;
}

function addTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    const indicatorDiv = document.createElement('div');
    indicatorDiv.className = 'flex items-start space-x-3';
    indicatorDiv.id = 'typingIndicator';
    
    indicatorDiv.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm">ðŸ¤–</span>
            </div>
        </div>
        <div class="flex-1">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(indicatorDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return indicatorDiv;
}

function askQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage(question);
}

async function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        try {
            await fetch('/api/chat/clear', { method: 'POST' });
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm">ðŸ¤–</span>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>Threat Intelligence Assistant:</strong> Chat history cleared. How can I help you today?
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            messageCount = 0;
            document.getElementById('messageCount').textContent = messageCount;
        } catch (error) {
            console.error('Error clearing chat:', error);
        }
    }
}

function exportChat() {
    const messagesContainer = document.getElementById('chatMessages');
    const messages = Array.from(messagesContainer.children).map(msg => {
        const role = msg.querySelector('.bg-blue-500') ? 'User' : 'Assistant';
        const content = msg.querySelector('p').textContent;
        const time = msg.querySelector('.text-xs.text-gray-500')?.textContent || '';
        return `[${time}] ${role}: ${content}`;
    }).join('\n\n');
    
    const blob = new Blob([messages], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `threat-intelligence-chat-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

async function trainOnBlogContent() {
    const button = event.target;
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.textContent = 'ðŸ§  Training...';
        
        const response = await fetch('/api/chat/train', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok) {
            // Add training message to chat
            addMessage('system', `Training completed: ${result.message}`, false);
            
            // Show success notification
            alert(`Training successful! ${result.message}`);
        } else {
            throw new Error(result.detail || 'Training failed');
        }
    } catch (error) {
        console.error('Training error:', error);
        alert(`Training failed: ${error.message}`);
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}
</script>
{% endblock %}
